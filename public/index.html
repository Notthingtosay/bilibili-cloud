<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bilibili 弹幕词云 (极速本地版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { bilibili: { pink: '#FB7299', blue: '#23ADE5', gray: '#F4F5F7', dark: '#18191C' } },
                    animation: { 'float': 'float 4s ease-in-out infinite', 'pop-in': 'popIn 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards' },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-6px)' } },
                        popIn: { '0%': { opacity: '0', transform: 'scale(0.8)' }, '100%': { opacity: '1', transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>
    <style>
        .grid-bg { background-image: radial-gradient(#FB7299 1px, transparent 1px); background-size: 20px 20px; opacity: 0.1; }
        #wordCloudContainer { min-height: 500px; width: 100%; position: relative; }
        #customTooltip {
            pointer-events: none;
            position: fixed;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.2s, transform 0.2s;
            z-index: 9999;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        #customTooltip.show { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body class="bg-bilibili-gray min-h-screen font-sans text-gray-700 flex flex-col">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <i class="fa-brands fa-bilibili text-bilibili-pink text-3xl"></i>
                <h1 class="text-xl font-bold text-gray-800">弹幕词云 <span class="text-xs bg-blue-600 text-white px-2 py-0.5 rounded ml-2">Node极速版</span></h1>
            </div>
            <div class="text-xs text-gray-400">Server Connected</div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-8 max-w-5xl">
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">输入视频 BV 号</h2>
                <p class="text-gray-500 text-sm">通过本地服务器极速抓取，无惧接口拥堵</p>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 justify-center items-center max-w-2xl mx-auto">
                <input type="text" id="bvInput" placeholder="例如：1f44y1M7M6" 
                    class="w-full pl-6 pr-4 py-3 rounded-xl border-2 border-gray-200 focus:border-bilibili-pink outline-none transition-all text-lg"
                    value="1f44y1M7M6">
                <button onclick="startGenerate()" id="generateBtn"
                    class="w-full sm:w-auto px-8 py-3 bg-bilibili-pink hover:bg-pink-500 text-white font-bold rounded-xl shadow-lg transition-all flex items-center justify-center gap-2">
                    <span>生成词云</span>
                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                </button>
            </div>
        </div>

        <div id="loadingSection" class="hidden flex-col items-center justify-center py-12">
            <i class="fa-solid fa-circle-notch fa-spin text-4xl text-bilibili-pink mb-4"></i>
            <p id="loadingText" class="text-gray-500 font-medium">正在请求服务器...</p>
        </div>

        <div id="resultSection" class="hidden space-y-6">
            <div class="flex justify-between items-center px-2">
                <span id="dataStatus" class="text-xs font-bold px-2 py-1 rounded bg-gray-200 text-gray-600">Waiting...</span>
                <span class="text-xs text-gray-400">词云样式已优化</span>
            </div>
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden relative border border-gray-100" style="min-height: 500px;">
                <div class="absolute inset-0 grid-bg"></div>
                <div id="wordCloudContainer" class="absolute inset-0 overflow-hidden cursor-crosshair"></div>
                <div class="absolute bottom-3 right-4 text-gray-200 font-bold text-sm pointer-events-none select-none">BILIBILI WORD CLOUD</div>
            </div>
            <div class="flex justify-center">
                 <button onclick="downloadImage()" class="text-gray-500 hover:text-bilibili-pink text-sm underline">保存为图片</button>
            </div>
        </div>
    </main>

    <div id="customTooltip" class="text-white px-4 py-2 rounded-lg text-sm flex flex-col items-center">
        <span id="tooltipText" class="font-bold text-base mb-0.5 text-pink-300"></span>
        <span id="tooltipCount" class="text-xs text-gray-300"></span>
        <div class="absolute w-2 h-2 bg-gray-800 transform rotate-45 -bottom-1 left-1/2 -translate-x-1/2 border-r border-b border-white/10"></div>
    </div>

    <script>
        const PALETTE = ['#FB7299', '#23ADE5', '#FFB027', '#F45A8D', '#00A1D6', '#42C9A6', '#9B59B6', '#E74C3C', '#34495E', '#1ABC9C', '#F39C12', '#8E44AD'];
        const MOCK_WORDS = ["高能", "前方高能", "下次一定", "AWSL", "哈哈哈哈", "泪目", "妙啊", "这不科学", "注入灵魂", "好活", "甚至"];

        async function startGenerate() {
            const bvId = document.getElementById('bvInput').value.trim();
            if (!bvId) return alert("请输入 BV 号！");

            const loading = document.getElementById('loadingSection');
            const result = document.getElementById('resultSection');
            const btn = document.getElementById('generateBtn');
            const container = document.getElementById('wordCloudContainer');

            loading.classList.remove('hidden'); loading.classList.add('flex');
            result.classList.add('hidden');
            btn.disabled = true; btn.classList.add('opacity-50');
            container.innerHTML = ''; 

            try {
                document.getElementById('loadingText').innerText = "服务器正在极速抓取...";
                
                // 请求本地后端
                const realData = await Promise.race([
                    fetchRealDanmaku(bvId),
                    new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 8000))
                ]);

                showResult(realData, "✅ 实时弹幕数据 (Node后端)");

            } catch (err) {
                console.warn("请求失败:", err);
                document.getElementById('loadingText').innerText = "请求异常，切换演示数据...";
                await new Promise(r => setTimeout(r, 800));
                const mockData = generateMockData();
                showResult({ words: mockData }, "⚠️ 演示数据 (服务器异常)");
            } finally {
                loading.classList.add('hidden'); loading.classList.remove('flex');
                btn.disabled = false; btn.classList.remove('opacity-50');
            }
        }

        function showResult(data, statusText) {
            const result = document.getElementById('resultSection');
            const statusBadge = document.getElementById('dataStatus');
            const container = document.getElementById('wordCloudContainer');

            statusBadge.innerText = statusText;
            statusBadge.className = statusText.includes('✅') 
                ? "text-xs font-bold px-2 py-1 rounded bg-green-100 text-green-700"
                : "text-xs font-bold px-2 py-1 rounded bg-orange-100 text-orange-700";

            result.classList.remove('hidden');
            result.classList.add('animate-pop-in');
            setTimeout(() => {
                renderWords(container, data.words);
                result.scrollIntoView({ behavior: 'smooth' });
            }, 50);
        }

        // 修改：直接请求相对路径 /api/xxx，不再跨域
        async function fetchRealDanmaku(bvid) {
            // 1. 获取 CID
            const infoRes = await fetch(`/api/view?bvid=${encodeURIComponent(bvid)}`);
            if (!infoRes.ok) throw new Error("API /view Error");
            const infoData = await infoRes.json();
            
            if (infoData.code !== 0 || !infoData.data?.cid) throw new Error("View接口返回错误");
            const cid = infoData.data.cid;

            // 2. 获取 XML
            const dmRes = await fetch(`/api/dm?cid=${cid}`);
            if (!dmRes.ok) throw new Error("API /dm Error");
            const xmlText = await dmRes.text();

            // 3. 解析 (保持不变)
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, "text/xml");
            const dNodes = xmlDoc.getElementsByTagName("d");
            if (!dNodes.length) throw new Error("No danmaku");

            const freq = {};
            // 本地跑得快，可以多处理一点
            for (let i = 0; i < Math.min(dNodes.length, 2500); i++) {
                const text = dNodes[i].textContent || '';
                const parts = text.split(/[^a-zA-Z0-9\u4e00-\u9fa5]+/g);
                parts.forEach(w => {
                    if (w.length >= 2 && w.length <= 8 && !/^\d+$/.test(w)) {
                        freq[w] = (freq[w] || 0) + 1;
                    }
                });
            }

            const words = Object.entries(freq)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 60)
                .map(([text, count]) => ({ 
                    text, 
                    count, 
                    weight: Math.min(count * 5 + 12, 75) 
                }));
            
            if (!words.length) throw new Error("No valid words");
            return { words };
        }

        function generateMockData() {
            const data = [];
            for (let i = 0; i < 40; i++) {
                const count = Math.floor(Math.random() * 50) + 5;
                data.push({
                    text: MOCK_WORDS[Math.floor(Math.random() * MOCK_WORDS.length)],
                    count: count,
                    weight: Math.max(14, 50 - i)
                });
            }
            return data.sort((a,b) => b.weight - a.weight);
        }

        // 保持完美的渲染逻辑
        function renderWords(container, words) {
            const cw = container.offsetWidth || 800;
            const ch = container.offsetHeight || 500;
            const centerX = cw / 2;
            const centerY = ch / 2;
            const placedRects = [];
            
            container.innerHTML = '';
            const tooltip = document.getElementById('customTooltip');
            const tooltipText = document.getElementById('tooltipText');
            const tooltipCount = document.getElementById('tooltipCount');

            let colorUsage = {};
            PALETTE.forEach(c => colorUsage[c] = 0);

            words.forEach((item, index) => {
                const el = document.createElement('span');
                el.innerText = item.text;
                el.style.fontSize = `${item.weight}px`;
                
                let availableColors = PALETTE.filter(c => colorUsage[c] < 5);
                if (availableColors.length === 0) availableColors = PALETTE;
                const color = availableColors[Math.floor(Math.random() * availableColors.length)];
                colorUsage[color]++;
                
                el.style.color = color;
                el.style.position = 'absolute';
                el.style.whiteSpace = 'nowrap';
                el.style.fontWeight = index < 6 ? '800' : '600';
                el.style.lineHeight = '1';
                el.className = 'cursor-pointer select-none transition-transform duration-200';
                el.style.textShadow = '1px 1px 0 #fff, -1px -1px 0 #fff';
                el.style.left = '-999px';
                el.style.opacity = '0';
                
                container.appendChild(el);

                const w = el.offsetWidth;
                const h = el.offsetHeight;
                let bestX = centerX - w / 2;
                let bestY = centerY - h / 2;

                if (index > 0) {
                    let angle = 0, radius = 0;
                    for (let i = 0; i < 600; i++) {
                        radius += 2.5;
                        angle += 0.3;
                        const x = centerX + radius * Math.cos(angle) - w / 2;
                        const y = centerY + radius * Math.sin(angle) - h / 2;
                        if (x < 10 || y < 10 || x + w > cw - 10 || y + h > ch - 10) continue;
                        const rect = { x, y, w, h };
                        if (!placedRects.some(r => checkCollision(rect, r))) { bestX = x; bestY = y; break; }
                    }
                }

                placedRects.push({ x: bestX, y: bestY, w, h });
                el.style.left = `${bestX}px`;
                el.style.top = `${bestY}px`;

                el.addEventListener('mouseenter', (e) => {
                    el.style.zIndex = 100;
                    el.style.transform = 'scale(1.15)';
                    tooltipText.innerText = item.text;
                    tooltipCount.innerText = `出现 ${item.count} 次`;
                    tooltip.classList.add('show');
                    updateTooltip(e);
                });
                el.addEventListener('mousemove', updateTooltip);
                el.addEventListener('mouseleave', () => {
                    el.style.zIndex = 'auto';
                    el.style.transform = 'scale(1)';
                    tooltip.classList.remove('show');
                });

                setTimeout(() => {
                    el.style.opacity = '1';
                    el.classList.add('animate-pop-in');
                    if (index < 8) el.style.animation = `float ${3 + Math.random()}s ease-in-out infinite`;
                }, index * 20);
            });

            function updateTooltip(e) {
                const tw = tooltip.offsetWidth;
                const th = tooltip.offsetHeight;
                tooltip.style.left = `${e.clientX - tw/2}px`;
                tooltip.style.top = `${e.clientY - th - 15}px`;
            }
        }

        function checkCollision(r1, r2) {
            const margin = 8; 
            return !(r2.x > r1.x + r1.w + margin || r2.x + r2.w + margin < r1.x || r2.y > r1.y + r1.h + margin || r2.y + r2.h + margin < r1.y);
        }

        async function downloadImage() {
            const target = document.getElementById('resultSection');
            try {
                const canvas = await html2canvas(target, { backgroundColor: '#fff' });
                const link = document.createElement('a');
                link.download = `wordcloud_${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
            } catch (e) { alert("保存失败"); }
        }
    </script>
</body>
</html>